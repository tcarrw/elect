<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Mayoral Finance Tracker | primary.plnt.earth</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.06) 0%, transparent 50%),
                linear-gradient(135deg, #0c1e30 0%, #1e3a52 25%, #2d5175 50%, #1e3a52 75%, #0c1e30 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
        }

        body::before { /* THIS IS YOUR STARRY BACKGROUND */
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(1px 1px at 20px 30px, #ffd700, transparent),
                radial-gradient(1px 1px at 40px 70px, rgba(255, 215, 0, 0.5), transparent),
                radial-gradient(1px 1px at 90px 40px, #ffd700, transparent);
            background-repeat: repeat;
            background-size: 150px 150px;
            opacity: 0.2;
            z-index: -1;
            animation: twinkle 6s ease-in-out infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.1; }
            100% { opacity: 0.3; }
        }

        .header {
            text-align: center;
            padding: 1.5rem 1rem; /* Adjusted padding for logo */
            background: rgba(12, 30, 48, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        /* Logo Styles Start */
        .site-logo {
            font-family: 'Orbitron', sans-serif; /* Font similar to tech/space themes */
            font-size: 1.8rem; /* Adjust size as needed */
            font-weight: 700;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logo-primary {
            /* Using the same gradient as your H1 for "PRIMARY" */
            background: linear-gradient(45deg, #2e8b57, #48d1cc, #20b2aa, #2e8b57);
            background-size: 200% 200%; /* Adjusted for potential animation if desired */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* text-fill-color: transparent; /* Standard property */
            animation: shimmer 4s ease-in-out infinite alternate; /* Optional: subtle shimmer */
        }

        .logo-domain {
            color: #ffd700; /* Gold color from your theme for ".PLNT.EARTH" */
            font-weight: 400; /* Slightly lighter weight for domain part */
        }
        /* Logo Styles End */

        .header h1 { /* This is your "NYC Mayoral Finance Tracker" title */
            font-size: 2.6rem; /* Slightly adjusted to accommodate logo */
            font-weight: 900;
            margin-bottom: 0.3rem;
            background: linear-gradient(45deg, #2e8b57, #48d1cc, #20b2aa, #2e8b57);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* text-fill-color: transparent; */
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 1.1rem;
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .election-info {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            padding: 1rem;
            border-radius: 15px;
            margin: 0.5rem auto;
            max-width: 600px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            font-size: 0.9rem;
        }

        /* ... rest of your existing CSS ... */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .dashboard-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #ffd700;
            margin-bottom: 0.3rem;
        }

        .kpi-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .alert-box {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.15), rgba(220, 53, 69, 0.08));
            border: 1px solid rgba(220, 53, 69, 0.4);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .alert-title {
            font-weight: 700;
            color: #ff6b6b;
            margin-bottom: 0.5rem;
        }

        .candidates-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(580px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .candidate-widget {
            background: linear-gradient(135deg, rgba(30, 58, 82, 0.8), rgba(45, 81, 117, 0.6));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.5rem;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .candidate-widget.trending {
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .candidate-widget.problematic {
            border-color: rgba(220, 53, 69, 0.6);
        }

        .candidate-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .candidate-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid rgba(255, 215, 0, 0.5);
            object-fit: cover;
            background: linear-gradient(45deg, #2e8b57, #48d1cc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }

        .candidate-info {
            flex: 1;
        }

        .candidate-name {
            font-size: 1.4rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 0.3rem;
        }

        .candidate-party {
            color: #ffd700;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .polling-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .polling-bar {
            flex: 1;
            background: rgba(255, 215, 0, 0.2);
            height: 6px;
            border-radius: 10px;
            overflow: hidden;
        }

        .polling-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border-radius: 10px;
            transition: width 2s ease;
        }

        .polling-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: #ffd700;
            min-width: 50px;
        }

        .candidate-status {
            font-size: 0.8rem;
            opacity: 0.9;
            padding: 0.3rem 0.8rem;
            background: rgba(46, 139, 87, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(46, 139, 87, 0.4);
        }

        .widget-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }

        .stat-item {
            background: rgba(12, 30, 48, 0.6);
            padding: 0.8rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffd700;
            display: block;
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-top: 0.2rem;
        }

        .chart-section {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .mini-chart {
            background: rgba(12, 30, 48, 0.4);
            border-radius: 10px;
            padding: 0.8rem;
            border: 1px solid rgba(255, 215, 0, 0.2);
            height: 120px;
        }

        .chart-title-mini {
            font-size: 0.8rem;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .warning-text {
            font-size: 0.75rem;
            color: #ff6b6b;
            margin-top: 0.5rem;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #ffd700;
        }

        .overview-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .chart-container {
            background: rgba(30, 58, 82, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #ffd700;
        }

        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(12, 30, 48, 0.95);
            color: white;
            border-radius: 10px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            max-width: 280px;
            z-index: 1000;
        }

        .data-sources {
            background: rgba(12, 30, 48, 0.8);
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 2rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
            font-size: 0.9rem;
        }

        .data-sources h3 {
            color: #ffd700;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }

        .data-sources a {
            color: #48d1cc;
            text-decoration: none;
        }

        .data-sources a:hover {
            color: #ffd700;
        }

        .mobile-stats {
            display: none;
            background: rgba(12, 30, 48, 0.8);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .mobile-stats.active {
            display: block;
        }

        .mobile-toggle {
            display: none;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .mobile-toggle:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        .mobile-detail {
            font-size: 0.85rem;
            margin: 0.3rem 0;
            padding: 0.3rem;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 5px;
        }

        .mobile-detail strong {
            color: #ffd700;
        }

        .chart-mobile-info {
            display: none;
            background: rgba(12, 30, 48, 0.6);
            border-radius: 8px;
            padding: 0.8rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .chart-mobile-info.active {
            display: block;
        }

        .touch-indicator {
            display: none;
            text-align: center;
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.7);
            margin-top: 0.3rem;
        }

        @media (max-width: 1200px) {
            .candidates-container {
                grid-template-columns: 1fr;
            }
            
            .widget-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 { /* Dashboard title */
                font-size: 1.8rem; /* Adjusted for logo */
            }
            .site-logo { /* Logo itself */
                font-size: 1.5rem; /* Smaller logo on mobile */
            }
            
            .candidate-header {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
            }

            .mobile-toggle {
                display: block;
            }

            .touch-indicator {
                display: block;
            }

            .chart-mobile-info {
                display: block;
            }

            .mini-chart {
                position: relative;
            }

            .overview-charts {
                grid-template-columns: 1fr;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .mobile-toggle {
                display: block;
            }

            .touch-indicator {
                display: block;
            }

            .chart-mobile-info {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="site-logo">
            <span class="logo-primary">PRIMARY</span><span class="logo-domain">.PLNT.EARTH</span>
        </div>
        <h1>NYC Mayoral Finance Tracker</h1>
        <p>Real-time campaign finance dashboard for the 2025 race</p>
        <div class="election-info">
            <strong>Democratic Primary:</strong> June 24, 2025 | <strong>General Election:</strong> November 2025<br>
            <small>Live data from NYC Campaign Finance Board ‚Ä¢ Updated May 30, 2025</small>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-header">
            <div class="kpi-card">
                <div class="kpi-value">$28.4M</div>
                <div class="kpi-label">Total Raised</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">$15.2M</div>
                <div class="kpi-label">Public Matching</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">31,750</div>
                <div class="kpi-label">Donors</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">68%</div>
                <div class="kpi-label">Avg Small Donors</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">24</div>
                <div class="kpi-label">Days to Primary</div>
            </div>
        </div>

        <div class="alert-box">
            <div class="alert-title">üö® Campaign Finance Issues</div>
            <p><strong>Cuomo:</strong> $1.3M withheld for PAC coordination ‚Ä¢ <strong>Adams:</strong> All public funds denied</p>
        </div>

        <h2 class="section-title">Candidate Finance Dashboard</h2>
        <div id="candidates-container" class="candidates-container"></div>

        <div class="overview-charts">
            <div id="comparison-chart" class="chart-container"></div>
            <div id="efficiency-chart" class="chart-container"></div>
        </div>
        
        <div class="data-sources">
            <h3>üìä Live Data Sources</h3>
            <p><strong>Primary:</strong> <a href="https://www.nyccfb.info/follow-the-money/" target="_blank">NYC Campaign Finance Board</a> | 
            <strong>Data:</strong> <a href="https://www.nyccfb.info/follow-the-money/data-library/" target="_blank">CFB Data Library</a> | 
            <strong>Polling:</strong> <a href="https://emersoncollegepolling.com/nyc-2025-poll/" target="_blank">Emerson College</a></p>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

   <script>
        // Color definitions (can remain as is)
        const colors = {
            "Small Donors": "#2e8b57",
            "Large Donors": "#ffd700",
            "Public Matching": "#48d1cc",
            "Media & Advertising": "#ff6b6b",
            "Staff & Consultants": "#4ecdc4",
            "Events & Outreach": "#45b7d1",
            "Digital & Technology": "#f9ca24",
            "Grassroots Organizing": "#6c5ce7",
            "Policy Research": "#fd79a8",
            "Community Outreach": "#00b894",
            "Legal Fees": "#e17055"
        };

        const tooltip = d3.select("#tooltip");

        function showTooltip(event, content) {
            tooltip.style("opacity", 1)
                   .html(content)
                   .style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 10) + "px");
        }

        function hideTooltip() {
            tooltip.style("opacity", 0);
        }

        function formatCurrency(amount) {
            if (amount >= 1000000) {
                return '$' + (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return '$' + (amount / 1000).toFixed(0) + 'K';
            }
            return '$' + amount.toLocaleString();
        }

        function createCandidateWidget(candidate, data) { // 'data' here is candidateData[candidateName]
            const container = d3.select("#candidates-container");
            const widget = container.append("div")
                .attr("class", `candidate-widget ${data.trend || ''}`);

            const header = widget.append("div")
                .attr("class", "candidate-header");

            header.append("div")
                .attr("class", "candidate-photo")
                .text(data.photo);

            const info = header.append("div")
                .attr("class", "candidate-info");

            info.append("div")
                .attr("class", "candidate-name")
                .text(candidate); // Candidate's name

            info.append("div")
                .attr("class", "candidate-party")
                .text(data.party);

            const pollingContainer = info.append("div")
                .attr("class", "polling-container");

            pollingContainer.append("div")
                .attr("class", "polling-text")
                .text(`${data.polling}%`);

            const pollingBar = pollingContainer.append("div")
                .attr("class", "polling-bar");

            pollingBar.append("div")
                .attr("class", "polling-fill")
                .style("width", "0%")
                .transition()
                .duration(2000)
                .style("width", `${data.polling}%`);

            info.append("div")
                .attr("class", "candidate-status")
                .text(data.status);

            const mobileToggle = widget.append("button")
                .attr("class", "mobile-toggle")
                .text("üìä Show Detailed Stats")
                .on("click", function() {
                    const mobileStats = widget.select(".mobile-stats");
                    const isActive = mobileStats.classed("active");
                    mobileStats.classed("active", !isActive);
                    d3.select(this).text(isActive ? "üìä Show Detailed Stats" : "üìä Hide Detailed Stats");
                });

            const content = widget.append("div")
                .attr("class", "widget-content");

            const statsSection = content.append("div")
                .attr("class", "stats-section");

            const stats = [
                {label: "Raised", value: formatCurrency(data.totalRaised)},
                {label: "Public", value: formatCurrency(data.publicFunds)},
                {label: "Spent", value: formatCurrency(data.totalSpent)},
                {label: "Small %", value: `${data.smallDonors}%`}
            ];

            stats.forEach(stat => {
                const statItem = statsSection.append("div")
                    .attr("class", "stat-item");
                statItem.append("span")
                    .attr("class", "stat-value")
                    .text(stat.value);
                statItem.append("div")
                    .attr("class", "stat-label")
                    .text(stat.label);
            });

            const chartSection = content.append("div")
                .attr("class", "chart-section");

            createTimelineChart(chartSection, data, candidate); // Pass specific candidate data and name
            createSpendingChart(chartSection, data, candidate); // Pass specific candidate data and name

            const mobileStats = widget.append("div")
                .attr("class", "mobile-stats");

            mobileStats.append("h4")
                .style("color", "#ffd700")
                .style("margin-bottom", "0.5rem")
                .text("üí∞ Funding Sources:");

            data.contributions.forEach(contrib => {
                mobileStats.append("div")
                    .attr("class", "mobile-detail")
                    .html(`<strong>${contrib.category}:</strong> ${formatCurrency(contrib.amount)} (${contrib.count.toLocaleString()} donors)`);
            });

            mobileStats.append("h4")
                .style("color", "#ffd700")
                .style("margin", "1rem 0 0.5rem 0")
                .text("üí∏ Campaign Spending:");

            data.spending.forEach(spend => {
                const percentage = (data.totalSpent > 0 ? (spend.amount / data.totalSpent) * 100 : 0).toFixed(1);
                mobileStats.append("div")
                    .attr("class", "mobile-detail")
                    .html(`<strong>${spend.category}:</strong> ${formatCurrency(spend.amount)} (${percentage}%)`);
            });
            
            const efficiency = data.totalSpent > 0 ? (data.polling / (data.totalSpent / 1000000)).toFixed(1) : "0";
            const remaining = data.totalRaised - data.totalSpent;
            
            mobileStats.append("h4")
                .style("color", "#ffd700")
                .style("margin", "1rem 0 0.5rem 0")
                .text("üìä Performance Metrics:");

            mobileStats.append("div")
                .attr("class", "mobile-detail")
                .html(`<strong>Campaign Efficiency:</strong> ${efficiency} polling points per $1M spent`);

            mobileStats.append("div")
                .attr("class", "mobile-detail")
                .html(`<strong>Remaining Funds:</strong> ${formatCurrency(remaining)}`);

            if (data.publicFundsWithheld > 0) {
                mobileStats.append("div")
                    .attr("class", "mobile-detail")
                    .style("color", "#ff6b6b")
                    .html(`<strong>‚ö†Ô∏è Withheld by CFB:</strong> ${formatCurrency(data.publicFundsWithheld)}`);
            }

            mobileStats.append("h4")
                .style("color", "#ffd700")
                .style("margin", "1rem 0 0.5rem 0")
                .text("üìà Monthly Timeline:");

            data.timelineData.forEach(month => {
                mobileStats.append("div")
                    .attr("class", "mobile-detail")
                    .html(`<strong>${month.month}:</strong> Raised ${formatCurrency(month.raised)}, Spent ${formatCurrency(month.spent)}`);
            });

            if (data.issues || data.publicFundsWithheld > 0) {
                widget.append("div")
                    .attr("class", "warning-text")
                    .text(data.issues ? `‚ö†Ô∏è ${data.issues}` : `‚ö†Ô∏è ${formatCurrency(data.publicFundsWithheld)} withheld`);
            }
        }

        function createTimelineChart(container, data, candidateName) { // 'data' is specific candidate's data
            const chartDiv = container.append("div")
                .attr("class", "mini-chart");

            chartDiv.append("div")
                .attr("class", "chart-title-mini")
                .text("Funding Timeline");

            const margin = {top: 10, right: 10, bottom: 20, left: 30};
            const width = 220 - margin.left - margin.right; // Ensure this fits or adjust
            const height = 80 - margin.top - margin.bottom; // Ensure this fits

            const svg = chartDiv.append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%") // Make responsive
                .style("max-width", `${width + margin.left + margin.right}px`); // Max width


            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const timelineData = data.timelineData;
            
            const x = d3.scaleBand()
                .range([0, width])
                .domain(timelineData.map(d => d.month))
                .padding(0.2);

            const yMax = d3.max(timelineData, d => Math.max(d.raised, d.spent));
            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, yMax === 0 ? 1 : yMax]); // Avoid domain of [0,0] if all values are 0

            g.selectAll(".raised-bar")
                .data(timelineData)
                .enter().append("rect")
                .attr("class", "raised-bar")
                .attr("x", d => x(d.month))
                .attr("width", x.bandwidth() / 2)
                .attr("y", d => y(d.raised))
                .attr("height", d => height - y(d.raised))
                .attr("fill", "#48d1cc")
                .attr("opacity", 0.7)
                .on("click", function(event, d) {
                    if (window.innerWidth <= 768) {
                        showTooltip(event, `
                            <strong>${candidateName} - ${d.month}</strong><br>
                            Raised: ${formatCurrency(d.raised)}<br>
                            Spent: ${formatCurrency(d.spent)}
                        `);
                        setTimeout(hideTooltip, 3000);
                    }
                });

            g.selectAll(".spent-bar")
                .data(timelineData)
                .enter().append("rect")
                .attr("class", "spent-bar")
                .attr("x", d => x(d.month) + x.bandwidth() / 2)
                .attr("width", x.bandwidth() / 2)
                .attr("y", d => y(d.spent))
                .attr("height", d => height - y(d.spent))
                .attr("fill", "#ffd700")
                .attr("opacity", 0.8)
                .on("click", function(event, d) {
                    if (window.innerWidth <= 768) {
                        showTooltip(event, `
                            <strong>${candidateName} - ${d.month}</strong><br>
                            Raised: ${formatCurrency(d.raised)}<br>
                            Spent: ${formatCurrency(d.spent)}
                        `);
                        setTimeout(hideTooltip, 3000);
                    }
                });

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "8px")
                .attr("fill", "white");

            g.selectAll(".domain, .tick line").attr("stroke", "rgba(255,255,255,0.3)");

            chartDiv.append("div")
                .attr("class", "touch-indicator")
                .text("üí° Tap bars for details");

            const mobileInfo = chartDiv.append("div")
                .attr("class", "chart-mobile-info");

            mobileInfo.append("div")
                .style("color", "#48d1cc")
                .style("margin-bottom", "0.3rem")
                .html("üü¶ <strong>Cyan bars:</strong> Monthly fundraising");

            mobileInfo.append("div")
                .style("color", "#ffd700")
                .html("üü® <strong>Gold bars:</strong> Monthly spending");
        }

        function createSpendingChart(container, data, candidateName) { // 'data' is specific candidate's data
            const chartDiv = container.append("div")
                .attr("class", "mini-chart");

            chartDiv.append("div")
                .attr("class", "chart-title-mini")
                .text("Spending Breakdown");

            const baseWidth = 180; // Base width for calculation
            const baseHeight = 80; // Base height for calculation
            const radius = Math.min(baseWidth / 2, baseHeight / 2) * 0.8; // Adjust radius dynamically

            const svg = chartDiv.append("svg")
                .attr("viewBox", `0 0 ${baseWidth} ${baseHeight}`) // Use viewBox for responsiveness
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%") // Make responsive
                .style("max-width", `${baseWidth}px`); // Set a max width


            const g = svg.append("g")
                .attr("transform", `translate(${baseWidth/2},${baseHeight/2})`);

            const pie = d3.pie()
                .value(d => d.amount)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5) // Adjusted inner radius
                .outerRadius(radius);

            const arcs = g.selectAll(".arc")
                .data(pie(data.spending.filter(d => d.amount > 0))) // Filter out 0 amount slices for cleaner pie
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => colors[d.data.category] || '#999')
                .style("opacity", 0.8)
                .style("cursor", "pointer")
                .on("mouseover", (event, d_arc) => { // d_arc is the arc datum
                    showTooltip(event, `
                        <strong>${candidateName}</strong><br>
                        ${d_arc.data.category}: ${formatCurrency(d_arc.data.amount)}<br>
                        ${(data.totalSpent > 0 ? (d_arc.data.amount / data.totalSpent) * 100 : 0).toFixed(1)}% of spending
                    `);
                })
                .on("mouseout", hideTooltip)
                .on("click", function(event, d_arc) {
                    if (window.innerWidth <= 768) {
                        showTooltip(event, `
                            <strong>${candidateName}</strong><br>
                            ${d_arc.data.category}: ${formatCurrency(d_arc.data.amount)}<br>
                            ${(data.totalSpent > 0 ? (d_arc.data.amount / data.totalSpent) * 100 : 0).toFixed(1)}% of spending
                        `);
                        setTimeout(hideTooltip, 3000);
                    }
                });
            
            const remaining = data.totalRaised - data.totalSpent;
            g.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-0.2em")
                .style("font-size", "10px") // Relative to viewBox
                .style("fill", "#ffd700")
                .style("font-weight", "bold")
                .text(formatCurrency(remaining));

            g.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.8em")
                .style("font-size", "8px") // Relative to viewBox
                .style("fill", "white")
                .text("remaining");

            chartDiv.append("div")
                .attr("class", "touch-indicator")
                .text("üí° Tap slices for details");
            
            const mobileInfo = chartDiv.append("div")
                .attr("class", "chart-mobile-info");

            mobileInfo.append("div")
                .style("font-weight", "bold")
                .style("color", "#ffd700")
                .style("margin-bottom", "0.3rem")
                .text("Spending Categories:");

            data.spending.forEach(spend => {
                if (spend.amount > 0) { // Only show legend for items in the pie
                    const percentage = (data.totalSpent > 0 ? (spend.amount / data.totalSpent) * 100 : 0).toFixed(0);
                    mobileInfo.append("div")
                        .style("font-size", "0.75rem")
                        .style("margin", "0.2rem 0")
                        .style("display", "flex")
                        .style("align-items", "center")
                        .style("gap", "0.3rem")
                        .html(`
                            <div style="width: 12px; height: 12px; background: ${colors[spend.category]}; border-radius: 2px; flex-shrink: 0;"></div>
                            <span>${spend.category}: ${percentage}%</span>
                        `);
                }
            });
        }

        // MODIFIED: createComparisonChart now accepts candidateData
        function createComparisonChart(candidateData) {
            const container = d3.select("#comparison-chart");
            container.html(""); // Clear previous chart if re-rendering
            container.append("div")
                .attr("class", "chart-title")
                .text("üí∞ Fundraising vs Spending Comparison");

            const margin = {top: 20, right: 80, bottom: 60, left: 80};
            
            // Adjust width calculation based on container, fallback to a default
            const containerWidth = container.node() ? container.node().getBoundingClientRect().width : 500;
            const width = Math.max(containerWidth - margin.left - margin.right, 250); // Ensure a min width
            const height = 300 - margin.top - margin.bottom;


            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const candidates = Object.keys(candidateData);
            
            const xMax = d3.max(candidates, name => candidateData[name].totalRaised);
            const yMax = d3.max(candidates, name => candidateData[name].totalSpent);

            const x = d3.scaleLinear()
                .range([0, width])
                .domain([0, xMax === 0 ? 1 : xMax]);


            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, yMax === 0 ? 1 : yMax]);


            g.selectAll(".candidate-point")
                .data(candidates)
                .enter().append("circle")
                .attr("class", "candidate-point")
                .attr("cx", d => x(candidateData[d].totalRaised))
                .attr("cy", d => y(candidateData[d].totalSpent))
                .attr("r", d => Math.sqrt(Math.max(0, candidateData[d].polling)) * 2) // Ensure polling is not negative for sqrt
                .attr("fill", d => candidateData[d].issues ? "#ff6b6b" : "#ffd700")
                .attr("opacity", 0.7)
                .on("mouseover", (event, d_name) => { // d_name is the candidate name
                    const data = candidateData[d_name];
                    showTooltip(event, `
                        <strong>${d_name}</strong><br>
                        Raised: ${formatCurrency(data.totalRaised)}<br>
                        Spent: ${formatCurrency(data.totalSpent)}<br>
                        Efficiency: ${(data.totalSpent > 0 ? (data.polling / (data.totalSpent / 1000000)) : 0).toFixed(1)} pts/$M<br>
                        Polling: ${data.polling}%
                    `);
                })
                .on("mouseout", hideTooltip);

            g.selectAll(".candidate-label")
                .data(candidates)
                .enter().append("text")
                .attr("class", "candidate-label")
                .attr("x", d => x(candidateData[d].totalRaised) + 8)
                .attr("y", d => y(candidateData[d].totalSpent) + 4)
                .style("font-size", "10px")
                .style("fill", "white")
                .text(d => d.split(' ')[1] || d.split(' ')[0]);

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => formatCurrency(d)))
                .selectAll("text")
                .style("fill", "white")
                .style("font-size", "10px");

            g.append("g")
                .call(d3.axisLeft(y).tickFormat(d => formatCurrency(d)))
                .selectAll("text")
                .style("fill", "white")
                .style("font-size", "10px");

            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 15) // Adjusted for better positioning
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("fill", "#ffd700")
                .style("font-size", "12px")
                .text("Total Spent");

            g.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 15})`) // Adjusted
                .style("text-anchor", "middle")
                .style("fill", "#ffd700")
                .style("font-size", "12px")
                .text("Total Raised");

            g.selectAll(".domain, .tick line").attr("stroke", "rgba(255,255,255,0.3)");
        }

        // MODIFIED: createEfficiencyChart now accepts candidateData
        function createEfficiencyChart(candidateData) {
            const container = d3.select("#efficiency-chart");
            container.html(""); // Clear previous chart if re-rendering
            container.append("div")
                .attr("class", "chart-title")
                .text("üìä Campaign Efficiency (Polling / Spending)");

            const margin = {top: 20, right: 40, bottom: 100, left: 60};
            const containerWidth = container.node() ? container.node().getBoundingClientRect().width : 500;
            const width = Math.max(containerWidth - margin.left - margin.right, 250); // Ensure a min width
            const height = 300 - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const candidates = Object.keys(candidateData);
            const efficiencyData = candidates.map(name => {
                const data = candidateData[name];
                const efficiency = data.totalSpent > 0 ? data.polling / (data.totalSpent / 1000000) : 0;
                return {
                    name: name,
                    efficiency: efficiency,
                    polling: data.polling,
                    issues: data.issues
                };
            }).sort((a, b) => b.efficiency - a.efficiency);
            
            const yMax = d3.max(efficiencyData, d => d.efficiency);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(efficiencyData.map(d => d.name))
                .padding(0.2);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, yMax === 0 ? 1 : yMax]);

            g.selectAll(".efficiency-bar")
                .data(efficiencyData)
                .enter().append("rect")
                .attr("class", "efficiency-bar")
                .attr("x", d => x(d.name))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.efficiency))
                .attr("height", d => height - y(d.efficiency))
                .attr("fill", d => d.issues ? "#ff6b6b" : "#48d1cc")
                .attr("rx", 3)
                .on("mouseover", (event, d_eff) => { // d_eff is the efficiency datum
                    showTooltip(event, `
                        <strong>${d_eff.name}</strong><br>
                        Efficiency: ${d_eff.efficiency.toFixed(1)} polling pts per $1M<br>
                        Current Polling: ${d_eff.polling}%<br>
                        ${d_eff.issues ? `Issue: ${d_eff.issues}` : 'No compliance issues'}
                    `);
                })
                .on("mouseout", hideTooltip);

            g.selectAll(".efficiency-label")
                .data(efficiencyData)
                .enter().append("text")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.efficiency) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "#ffd700")
                .style("font-weight", "bold")
                .text(d => d.efficiency.toFixed(1));

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)")
                .style("fill", "white")
                .style("font-size", "9px");

            g.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .style("fill", "white")
                .style("font-size", "10px");

            g.selectAll(".domain, .tick line").attr("stroke", "rgba(255,255,255,0.3)");

            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 15) // Adjusted
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("fill", "#ffd700")
                .style("font-size", "11px")
                .text("Polling Points per $1M Spent");
        }

        // Main function to fetch data and initialize the dashboard
        async function fetchDataAndInitialize() {
            try {
                // Path to your JSON file. Ensure this file is in the same directory or provide the correct path.
                const response = await fetch('candidate_data.json'); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const loadedCandidateData = await response.json();

                // Data is loaded, now initialize the dashboard components
                initializeDashboard(loadedCandidateData);

            } catch (error) {
                console.error("Could not load candidate data:", error);
                // Display an error message on the page
                const container = d3.select(".container");
                container.insert("div", ":first-child") // Insert at the beginning of the container
                    .attr("class", "alert-box")
                    .style("border-color", "red")
                    .html(`<div class="alert-title" style="color: red;">Error Loading Data</div>
                           <p>Could not load candidate financial data. Please try again later or check the console for more details.</p>`);
            }
        }

        function initializeDashboard(candidateData) {
            // Clear existing candidate widgets if any (for re-initialization if needed)
            d3.select("#candidates-container").html("");

            // Create candidate widgets
            Object.keys(candidateData).forEach(candidateName => {
                createCandidateWidget(candidateName, candidateData[candidateName]);
            });

            // Create overview charts, passing the loaded data
            // The timeouts can remain if they are for visual staggering of chart rendering
            setTimeout(() => createComparisonChart(candidateData), 100); // Reduced timeout as data is ready
            setTimeout(() => createEfficiencyChart(candidateData), 200);  // Reduced timeout
        }

        // Start the process
        fetchDataAndInitialize();
    </script>
</body>
</html>
